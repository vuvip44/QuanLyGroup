@model List<QuanLy.ViewModel.Response.User.UserViewModel>
@using System.Linq
@using QuanLy.ViewModel.Response
@using QuanLy.ViewModel.Response.User

@{
    ViewData["Title"] = "Group Management";
    var pageResponse = ViewBag.PageResponse as PageResponse<List<UserViewModel>>;
    int? selectedGroupId = ViewBag.SelectedGroupId;
    string searchName = ViewBag.SearchName;
    string groupTreeData = ViewBag.GroupTreeData;
}

<h1>Group Management</h1>

<div class="row">
    <!-- Phần Groups (bên trái) -->
    <div class="col-md-4">
        <h2>Groups</h2>
        <a asp-action="Create" class="btn btn-primary mb-3">Create New Group</a>
        <div id="groupTree"></div>
    </div>

    <!-- Phần Users in Selected Group (bên phải) -->
    <div class="col-md-8">
        <h2>Users in Selected Group</h2>
        @if (selectedGroupId != null)

        {
            <!-- Ô tìm kiếm -->
            <form asp-action="Index" method="get" class="mb-3">
                <div class="input-group">
                    <input type="hidden" name="groupId" value="@selectedGroupId" />
                    <input type="hidden" name="page" value="1" />
                    <input type="hidden" name="pageSize" value="@(pageResponse?.PageSize ?? 20)" />
                    <input type="text" name="name" class="form-control" placeholder="Search by name..."
                        value="@searchName" />
                    <div class="input-group-append">
                        <button type="submit" class="btn btn-primary">Search</button>
                        <a class="btn btn-secondary" asp-action="Index" asp-route-groupId="@selectedGroupId"
                            asp-route-page="1" asp-route-pageSize="@(pageResponse?.PageSize ?? 20)">Clear</a>
                    </div>
                </div>
            </form>

            @if (Model != null && Model.Any())
            {
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Account</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model)
                        {
                            <tr>
                                <td>@user.Name</td>
                                <td>@user.Email</td>
                                <td>@user.Account</td>
                            </tr>
                        }
                    </tbody>
                </table>

                <!-- Phân trang -->
                @if (pageResponse != null && pageResponse.TotalPage > 1)
                {
                    <nav aria-label="Page navigation">
                        <ul class="pagination">
                            <!-- Nút Previous -->
                            <li class="page-item @(pageResponse.Page == 1 ? "disabled" : "")">
                                <a class="page-link" asp-action="Index" asp-route-groupId="@selectedGroupId"
                                    asp-route-page="@(pageResponse.Page - 1)" asp-route-pageSize="@pageResponse.PageSize"
                                    asp-route-name="@searchName">Previous</a>
                            </li>

                            <!-- Các trang -->
                            @for (int i = 1; i <= pageResponse.TotalPage; i++)
                            {
                                <li class="page-item @(i == pageResponse.Page ? "active" : "")">
                                    <a class="page-link" asp-action="Index" asp-route-groupId="@selectedGroupId" asp-route-page="@i"
                                        asp-route-pageSize="@pageResponse.PageSize" asp-route-name="@searchName">@i</a>
                                </li>
                            }

                            <!-- Nút Next -->
                            <li class="page-item @(pageResponse.Page == pageResponse.TotalPage ? "disabled" : "")">
                                <a class="page-link" asp-action="Index" asp-route-groupId="@selectedGroupId"
                                    asp-route-page="@(pageResponse.Page + 1)" asp-route-pageSize="@pageResponse.PageSize"
                                    asp-route-name="@searchName">Next</a>
                            </li>
                        </ul>
                    </nav>
                }
            }
            else
            {
                <p>No users found in this group.</p>
            }
        }
        else
        {
            <p>Please select a group to view users.</p>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Khởi tạo jsTree
            $('#groupTree').jstree({
                'core': {
                    'data': @Html.Raw(groupTreeData),
                    'themes': {
                        'dots': true
                    }
                }
            });

            // Xử lý sự kiện khi click vào một node trong cây
            $('#groupTree').on('select_node.jstree', function (e, data) {
                var groupId = data.node.id;
                window.location.href = '@Url.Action("Index", "Group")' + '?groupId=' + groupId + '&page=1';
            });

            // Tự động mở rộng và chọn node được chọn (nếu có)
            var selectedGroupId = '@selectedGroupId';
            $('#groupTree').on('ready.jstree', function () {
                $('#groupTree').jstree('open_all'); // Mở rộng toàn bộ cây
                if (selectedGroupId) {
                    $('#groupTree').jstree('select_node', selectedGroupId); // Chọn node
                }
            });
        });
    </script>
}